name: Testing Workflow
on:
  # Trigger the workflow on pull request
  pull_request_target:
    branches: 
      - main
      - master
    paths:
      - '**.md'
      - '**.ipynb'

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  command: 'check_paths_tracking'
  directory: './'
  guide-url: 'https://github.com/john0isaac/action-check-markdown/blob/main/CONTRIBUTING.md'

jobs:
  check-broken-paths:
    name: Check Broken Relative Paths
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          python setup.py develop

      - name: Run Check paths tracking
        run: |
          markdown-checker --dir ${{ env.directory }} --func ${{ env.command }} --guide-url ${{ env.guide-url }}

      - name: Set job summary
        if: always() && [ -f './comment.md']
        shell: bash
        run: cat ./comment.md >> $GITHUB_STEP_SUMMARY

      - name: Get PR number
        if: always() && [ -f './comment.md']
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: echo "pr_number=`gh pr view ${GITHUB_REF_NAME} --json number -q '.number'`" >> $GITHUB_ENV
      
      - name: Post comment
        if: ${{ always() && env.pr_number != '' }}
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr comment ${GITHUB_REF_NAME} -F ./comment.md

      - name: Update workflow run status
        if: always() && [ -f './comment.md']
        run: exit 1